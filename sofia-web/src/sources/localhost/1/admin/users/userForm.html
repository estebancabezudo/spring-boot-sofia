<link lib="inputs:email:1.00" />
<style>
    #userFormContainer {
        display: grid;
        grid-gap: 8px;
        grid-template-columns: repeat(5, 1fr);
        margin: 0 auto;
        max-width: 750px;
    }

    #groupsContainer {
        border: 1px solid rgb(207, 207, 207);
        border-radius: 5px;
        padding: 8px;
        display: grid;
        grid-gap: 8px;
        grid-template-columns: repeat(1, 1fr);
    }

    .groupContainer {
        display: flex;
        align-items: center;
    }

    .groupName {
        font-size: 20px;
    }

    #usernameLabel {
        grid-column: 1/6;
    }

    #usernameInput {
        grid-column: 1/6;
    }

    #userGroupsLabel {
        grid-column: 1/6;
    }

    #groupsContainer {
        grid-column: 1/6;
    }
</style>

<script>
    const NEW_GROUP_ID = 'newGroup';
    const NOT_CHECKED = 0;
    const EXISTS_IN_SERVER = 1;
    const OK = 2;

    let usernameBaseData, groupsBaseData, usernameInput, userSaveButton, userNameInServer = NOT_CHECKED;
    const createGroupContainer = (groupName, visible, newGroupId) => {
        const groupContainer = document.createElement('DIV');
        if (newGroupId && newGroupId.length > 0) {
            groupContainer.id = newGroupId;
        }
        groupContainer.className = 'groupContainer';

        const groupNameInput = document.createElement('INPUT');
        groupNameInput.className = 'textInput';
        groupNameInput.value = groupName;
        groupNameInput.spellcheck = false;
        groupNameInput.autocomplete = 'off';
        groupContainer.appendChild(groupNameInput);

        const deleteGropIconContainer = document.createElement('div');
        deleteGropIconContainer.setAttribute('class', 'deleteGroupContainer');
        groupContainer.appendChild(deleteGropIconContainer);

        const deleteGropIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        deleteGropIcon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        deleteGropIcon.setAttribute('width', '20');
        deleteGropIcon.setAttribute('height', '20');
        deleteGropIcon.setAttribute('class', 'deleteGroup');
        deleteGropIconContainer.appendChild(deleteGropIcon);

        const linea1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        linea1.setAttribute('x1', '5');
        linea1.setAttribute('y1', '5');
        linea1.setAttribute('x2', '15');
        linea1.setAttribute('y2', '15');
        linea1.setAttribute('stroke', 'gray');
        linea1.setAttribute('stroke-width', '2');
        const linea2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        linea2.setAttribute('x1', '15');
        linea2.setAttribute('y1', '5');
        linea2.setAttribute('x2', '5');
        linea2.setAttribute('y2', '15');
        linea2.setAttribute('stroke', 'gray');
        linea2.setAttribute('stroke-width', '2');
        deleteGropIcon.appendChild(linea1);
        deleteGropIcon.appendChild(linea2);

        deleteGropIconContainer.addEventListener('click', () => {
            deleteGropIconContainer.parentElement.remove();
            checkForChanges();
        })
        if (!visible) {
            deleteGropIcon.style.display = 'none';
        }

        groupNameInput.addEventListener('keyup', () => {
            if (groupNameInput.value.length > 2) {
                deleteGropIcon.style.display = 'block';
                if (groupNameInput.parentElement.id === NEW_GROUP_ID) {
                    groupNameInput.parentElement.id = '';
                    const groupContainer = createGroupContainer(null, false, NEW_GROUP_ID);
                    groupsContainer.appendChild(groupContainer);
                }
            } else {
                deleteGropIcon.style.display = 'none';
            }
            checkForChanges();
        });

        groupNameInput.addEventListener('focusout', () => {
            if (groupNameInput.value.length < 3 && groupNameInput.parentElement.id !== NEW_GROUP_ID) {
                groupNameInput.parentElement.remove();
            }
            checkForChanges();
        });

        return groupContainer;
    };
    const checkForChanges = () => {
        const theDataIsValid = () => {
            if (!usernameInput.isValid()) {
                return false;
            }
            if (userNameInServer === NOT_CHECKED) {
                return false;
            }
            if (userNameInServer === EXISTS_IN_SERVER) {
                usernameInput.setInvalid(true);
                return false;
            }
            return true;
        }
        const theDataChanged = () => {
            if (!groupsBaseData) {
                throw new Error('You must define a base data for groups');
            }
            if (usernameInput.getElement().value !== usernameBaseData) {
                console.log(`The username in base data is ${usernameBaseData} but in DOM is ${usernameInput.getElement().value}.`);
                return true;
            }
            // I don't check the size of the groups before because the DOM groups can have +1 or +2 groups more than base data and I also need the bucle to check that.
            let groupDOMSize = 0;
            for (const groupInput of groupsContainer.getElementsByClassName('textInput')) {
                if (groupInput.value.trim().length > 2) {
                    groupDOMSize++;
                    if (!groupsBaseData.includes(groupInput.value.trim())) {
                        return true;
                    }
                }
            };
            if (groupsBaseData.length !== groupDOMSize) {
                return true;
            }
            return false;
        };
        changeButtons(theDataIsValid() && theDataChanged());
    };
    const changeButtons = dataChange => {
        console.log(`Data change: ${dataChange}`);
        userSaveButton.disabled = !dataChange;
    };
    const formInit = () => {
        const showWaitingWeel = () => { document.getElementById('waitingImage').classList.remove('hideWaitingImage'); };
        const hideWaitingWeel = () => { document.getElementById('waitingImage').classList.add('hideWaitingImage'); };
        usernameInput = new EMailInput('usernameInput');
        usernameInput.getElement().addEventListener('input', () => {
            showWaitingWeel();
            userNameInServer = NOT_CHECKED;
            checkForChanges();
        })
        usernameInput.onInputEvent(() => {
            showWaitingWeel();
        });
        usernameInput.beforeValidation(() => {
            showWaitingWeel();
        });
        usernameInput.afterValidation(value => {
            hideWaitingWeel();
            console.log(`userForm.html::formInit::afterValidation::valid: ${usernameInput.isValid()}`);
            checkForChanges();
            if (usernameInput.isValid()) {
                if (userNameInServer === NOT_CHECKED) {
                    console.log(`userForm.html::formInit::afterValidation::fetch: /v1/users/${value}/exists`);
                    if (value === undefined || value.length < 3) {
                        usernameInput.setInvalid(false);
                        return;
                    }
                    usernameInput.setInvalid(false);
                    showWaitingWeel();
                    fetch(`/v1/users/${value}/exists`)
                        .then(response => {
                            hideWaitingWeel();
                            return response.json();
                        })
                        .then(response => {
                            console.log(`userForm.html::formInit::afterValidation::response.data: `, response.data);
                            if (response.data === undefined) {
                                userNameInServer = OK;
                                usernameInput.setInvalid(false);
                                checkForChanges();
                            } else {
                                userNameInServer = EXISTS_IN_SERVER;
                                usernameInput.setInvalid(true);
                                Core.showErrorMessage('usernameAlreadyExists');
                            }
                        })
                        .catch(error => {
                            Core.showErrorMessage(error.message);
                            Core.reportSystemError(error);
                        });
                }
            } else {
                usernameInput.setInvalid(true);
                checkForChanges();
            }
        });
    }
</script>

<body>
    <div id="userFormContainer" class="formContainer">
        <div id="usernameLabel" class="adminLabel">
            <texts><text language="es">Nombre de usuario</text><text language="en">Username</text></texts>
        </div>
        <input id="usernameInput" spellcheck="false" autocomplete="off">
        <div id="userGroupsLabel" class="adminLabel">
            <texts><text language="es">Grupos</text><text language="en">Groups</text></texts>
        </div>
        <div id="groupsContainer"></div>
    </div>
</body>